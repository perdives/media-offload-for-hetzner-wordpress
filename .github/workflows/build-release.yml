name: Build Release Package

# This workflow builds production-ready assets and attaches them to draft releases.
# It runs when code is merged to the release branch, creating a zip package that
# can be tested before publishing.

on:
  push:
    branches:
      - release
  workflow_dispatch:  # Allow manual trigger for rebuilding

permissions:
  contents: write

jobs:
  build:
    name: Build and Attach Assets
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Get plugin version
        id: version
        uses: perdives/wp-plugin-actions/get-plugin-version@main
        with:
          plugin_file: 'media-offload-for-hetzner.php'

      - name: Build plugin package
        uses: perdives/wp-plugin-actions/build-plugin@main
        with:
          plugin_slug: 'media-offload-for-hetzner'
          plugin_file: 'media-offload-for-hetzner.php'
          generate_checksum: true

      - name: Upload assets to release
        uses: perdives/wp-plugin-actions/upload-to-release@main
        with:
          tag: ${{ steps.version.outputs.tag }}
          files: 'media-offload-for-hetzner-*.zip media-offload-for-hetzner-*.sha256'
          wait_for_release: true
